---
export interface Props {
  businesses: any[];
  serviceTitle: string;
  serviceDescription?: string;
}

const { businesses, serviceTitle, serviceDescription } = Astro.props;

// ‚úÖ SMART LOGIC: Automatically extract unique neighborhoods from the data
const uniqueNeighborhoods = [...new Set(businesses.map(b => b.neighborhood).filter(n => n && n !== "N/A"))].sort();
---

<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  
  <div class="text-center mb-12">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
      {serviceTitle}
    </h1>

    {serviceDescription && (
      <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-6 leading-relaxed">
        {serviceDescription}
      </p>
    )}

    <div class="inline-flex items-center bg-blue-50 text-blue-700 px-4 py-2 rounded-full text-sm font-medium">
      <span class="mr-2">‚úì</span>
      {businesses.length} profissionais verificados com 4+ estrelas
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-8">
    <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
      
      <div class="relative w-full md:w-1/2">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input 
          type="text" 
          id="searchInput" 
          placeholder="Buscar por nome..."
          class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
        />
      </div>

      <div class="flex flex-wrap gap-4 w-full md:w-auto items-center">
        <select id="neighborhoodFilter" class="block w-full md:w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
          <option value="">Todos os bairros</option>
          {uniqueNeighborhoods.map(hood => (
            <option value={hood}>{hood}</option>
          ))}
        </select>

        <label class="inline-flex items-center cursor-pointer bg-gray-50 px-3 py-2 rounded-lg border border-gray-200">
          <input type="checkbox" id="only24h" class="form-checkbox h-5 w-5 text-blue-600 rounded" />
          <span class="ml-2 text-gray-700 font-medium">Apenas 24h</span>
        </label>
      </div>
    </div>
  </div>

  <div class="mb-6 text-gray-500 text-sm">
    Mostrando <span id="resultCount" class="font-bold text-gray-900">{businesses.length}</span> resultados
  </div>

  <div id="businessGrid" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    {businesses.map((business) => {
      // Normalization logic
      const displayName = business.name || business.business_name || "Profissional";
      const displayPhone = business.phone || business.phone_number || "";
      const displayRating = business.rating || business.star_rating || 0;
      const displayReviews = business.reviews || business.total_reviews || 0;
      const is24h = business.is_24h || business.badges?.includes('24 Horas');
      const isWomanOwned = business['Identifies as women-owned'] || business.badges?.includes('Empresa de mulheres');
      const isLgbtq = business['LGBTQ+ friendly'] || business.badges?.includes('LGBTQ+ friendly');
      
      return (
        <div class="business-card bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 border border-gray-200 overflow-hidden flex flex-col"
             data-name={displayName.toLowerCase()}
             data-neighborhood={business.neighborhood || ""}
             data-is24h={is24h}>
          
          <div class="p-6 flex-1">
            <div class="flex justify-between items-start mb-2">
              <h3 class="text-xl font-bold text-gray-900 line-clamp-2">{displayName}</h3>
              {is24h && (
                <span class="flex-shrink-0 bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded-full">
                  24h
                </span>
              )}
            </div>

            <div class="flex items-center mb-4">
              <span class="text-yellow-400 text-lg mr-1">‚≠ê</span>
              <span class="font-bold text-gray-900 mr-1">{displayRating}</span>
              <span class="text-gray-500 text-sm">({displayReviews} avalia√ß√µes)</span>
            </div>

            <div class="space-y-2 mb-4">
              {business.neighborhood && (
                <div class="flex items-start text-gray-600 text-sm">
                  <span class="mr-2">üìç</span>
                  <span class="font-medium">{business.neighborhood}</span>
                </div>
              )}
              {business.address && (
                <div class="text-gray-500 text-sm pl-6 line-clamp-2">
                  {business.address}
                </div>
              )}
            </div>
            
            <div class="flex flex-wrap gap-2 mt-3">
               {isWomanOwned && (
                 <span class="bg-pink-100 text-pink-700 px-2 py-1 rounded-md text-xs font-medium">
                   Empresa de mulheres
                 </span>
               )}
               {isLgbtq && (
                 <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-md text-xs font-medium">
                   LGBTQ+
                 </span>
               )}
            </div>
          </div>

          <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 grid grid-cols-2 gap-3">
            {displayPhone && (
              <a href={`tel:${displayPhone.replace(/\D/g, '')}`} 
                 class="flex items-center justify-center bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                üìû Ligar
              </a>
            )}
            
            {(business.whatsapp === true || (typeof business.whatsapp === 'string' && business.whatsapp.length > 5)) ? (
              <a href={typeof business.whatsapp === 'string' ? business.whatsapp : `https://wa.me/55${displayPhone.replace(/\D/g,'')}`}
                 target="_blank"
                 class="flex items-center justify-center bg-green-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-600 transition-colors">
                WhatsApp
              </a>
            ) : (
               <button disabled class="bg-gray-200 text-gray-400 py-2 px-4 rounded-lg font-medium cursor-not-allowed">
                 WhatsApp
               </button>
            )}
          </div>
          
          {business.description && (
             <div class="px-6 pb-4 bg-gray-50 text-xs text-gray-500 italic">
               "{business.description}"
             </div>
          )}
        </div>
      );
    })}
  </div>

  <div id="noResults" class="hidden text-center py-16 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
    <div class="text-4xl mb-4">üîç</div>
    <h3 class="text-lg font-medium text-gray-900">Nenhum profissional encontrado</h3>
    <p class="text-gray-500">Tente ajustar seus filtros ou buscar por outro termo.</p>
    <button id="clearSearch" class="mt-4 text-blue-600 font-medium hover:underline">
      Limpar todos os filtros
    </button>
  </div>

</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const neighborhoodFilter = document.getElementById('neighborhoodFilter') as HTMLSelectElement;
    const only24hCheckbox = document.getElementById('only24h') as HTMLInputElement;
    const cards = document.querySelectorAll('.business-card');
    const noResults = document.getElementById('noResults');
    const resultCount = document.getElementById('resultCount');
    const clearSearch = document.getElementById('clearSearch');

    function filterCards() {
      const searchTerm = searchInput.value.toLowerCase();
      const selectedHood = neighborhoodFilter.value;
      const showOnly24h = only24hCheckbox.checked;
      
      let visibleCount = 0;

      cards.forEach((card) => {
        const name = (card as HTMLElement).dataset.name || '';
        const neighborhood = (card as HTMLElement).dataset.neighborhood || '';
        // Handle boolean string conversation
        const is24h = (card as HTMLElement).dataset.is24h === 'true' || (card as HTMLElement).dataset.is24h === '';

        const matchesSearch = name.includes(searchTerm) || neighborhood.toLowerCase().includes(searchTerm);
        const matchesHood = selectedHood === '' || neighborhood === selectedHood;
        const matches24h = !showOnly24h || is24h;

        if (matchesSearch && matchesHood && matches24h) {
          (card as HTMLElement).style.display = 'flex';
          visibleCount++;
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });

      // Update UI
      if (resultCount) resultCount.textContent = visibleCount.toString();
      
      if (visibleCount === 0) {
        noResults?.classList.remove('hidden');
      } else {
        noResults?.classList.add('hidden');
      }
    }

    // Event Listeners
    searchInput?.addEventListener('input', filterCards);
    neighborhoodFilter?.addEventListener('change', filterCards);
    only24hCheckbox?.addEventListener('change', filterCards);
    
    clearSearch?.addEventListener('click', () => {
      searchInput.value = '';
      neighborhoodFilter.value = '';
      only24hCheckbox.checked = false;
      filterCards();
    });
  });
</script>
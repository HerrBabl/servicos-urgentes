---
// src/components/BusinessListing.astro
// Props: businesses (array), serviceTitle (string)

interface Props {
  businesses: any[];
  serviceTitle: string;
}

const { businesses, serviceTitle } = Astro.props;
---

<div class="business-directory">
  <div class="directory-header">
    <h1>{serviceTitle} em S√£o Jos√© dos Campos</h1>
    <p class="subtitle">
      {businesses.length} profissionais verificados com 4+ estrelas
    </p>
  </div>

  <div class="filters">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Buscar por nome ou bairro..."
      class="search-box"
    />
    
    <select id="neighborhoodFilter" class="filter-select">
      <option value="">Todos os bairros</option>
      <option value="Aquarius">Parque Residencial Aquarius</option>
      <option value="Bosque dos Eucaliptos">Bosque dos Eucaliptos</option>
      <option value="Centro">Centro</option>
      <option value="Jardim das Colinas">Jardim das Colinas</option>
      <option value="S√£o Dimas">S√£o Dimas</option>
      <option value="Urbanova">Urbanova</option>
      <option value="Vila Adyana">Vila Adyana</option>
      
      <option value="Bosque dos Ip√™s">Bosque dos Ip√™s</option>
      <option value="Cidade Morumbi">Cidade Morumbi</option>
      <option value="Dom Pedro II">Dom Pedro II</option>
      <option value="Jardim Aeroporto">Jardim Aeroporto</option>
      <option value="Jardim Alvorada">Jardim Alvorada</option>
      <option value="Jardim Am√©rica">Jardim Am√©rica</option>
      <option value="Jardim da Granja">Jardim da Granja</option>
      <option value="Jardim das Azaleias">Jardim das Azaleias</option>
      <option value="Jardim das Ind√∫strias">Jardim das Ind√∫strias</option>
      <option value="Jardim Ismenia">Jardim Ismenia</option>
      <option value="Jardim Morumbi">Jardim Morumbi</option>
      <option value="Jardim Oriente">Jardim Oriente</option>
      <option value="Jardim S√£o Dimas">Jardim S√£o Dimas</option>
      <option value="Jardim S√£o Vicente">Jardim S√£o Vicente</option>
      <option value="Jardim Sat√©lite">Jardim Sat√©lite</option>
      <option value="Jardim Vale do Sol">Jardim Vale do Sol</option>
      <option value="Palmeiras de S√£o Jos√©">Palmeiras de S√£o Jos√©</option>
      <option value="Parque Industrial">Parque Industrial</option>
      <option value="Res. de Ville">Res. de Ville</option>
      <option value="Vila C√¢ndida">Vila C√¢ndida</option>
      <option value="Vila Ema">Vila Ema</option>
      <option value="Vila Nair">Vila Nair</option>
      <option value="Vila S√£o Bento">Vila S√£o Bento</option>
      <option value="Vila Tesouro">Vila Tesouro</option>
      <option value="Vista Verde">Vista Verde</option>
    </select>

    <label class="filter-checkbox">
      <input type="checkbox" id="only24h" />
      Apenas 24 horas
    </label>
  </div>

  <div class="results-count">
    Mostrando <span id="resultCount">{businesses.length}</span> resultados
  </div>

  <div class="business-grid" id="businessGrid">
    {businesses.map((business) => {
      // SAFETY CHECK: Normalize data fields so it works with ANY data file
      const displayName = business.name || business.business_name || "Profissional";
      const displayPhone = business.phone || business.phone_number || "";
      const displayRating = business.rating || business.star_rating || 0;
      const displayReviews = business.reviews || business.total_reviews || 0;
      
      return (
        <div 
          class="business-card" 
          data-name={displayName.toLowerCase()}
          data-neighborhood={business.neighborhood || ""}
          data-is24h={business.is_24h || business.badges?.includes('24 Horas')}
        >
          <div class="business-header">
            <h3 class="business-name">{displayName}</h3>
            <div class="rating">
              <span class="stars">‚≠ê {displayRating}</span>
              <span class="reviews">({displayReviews} avalia√ß√µes)</span>
            </div>
          </div>

          <div class="business-info">
            {business.neighborhood && (
              <p class="location">üìç {business.neighborhood}</p>
            )}
            
            {business.address && (
              <p class="address">{business.address}</p>
            )}

            <div class="badges">
              {(business.is_24h || business.badges?.includes('24 Horas')) && (
                <span class="badge badge-24h">24 Horas</span>
              )}
              {(business['Identifies as women-owned'] || business.badges?.includes('Empresa de mulheres')) && (
                <span class="badge badge-women">Empresa de mulheres</span>
              )}
              {(business['LGBTQ+ friendly'] || business.badges?.includes('LGBTQ+ friendly')) && (
                <span class="badge badge-lgbtq">LGBTQ+ friendly</span>
              )}
               {business.badges?.includes('Verificado') && (
                <span class="badge badge-verified">Verificado</span>
              )}
            </div>
          </div>

          <div class="business-actions">
            {displayPhone && (
              <a 
                href={`tel:${displayPhone.replace(/\D/g,'')}`}
                class="btn btn-call"
              >
                üìû Ligar
              </a>
            )}
            
            {(business.whatsapp === true || (typeof business.whatsapp === 'string' && business.whatsapp.length > 5)) && (
              <a 
                href={typeof business.whatsapp === 'string' ? business.whatsapp : `https://wa.me/55${displayPhone.replace(/\D/g,'')}`}
                target="_blank"
                rel="noopener noreferrer"
                class="btn btn-whatsapp"
              >
                üí¨ WhatsApp
              </a>
            )}
            
            {business.website && business.website !== '' && business.website !== 'N/A' && business.website !== 'None' && (
              <a 
                href={business.website.startsWith('http') ? business.website : `https://${business.website}`}
                target="_blank"
                rel="noopener noreferrer"
                class="btn btn-website"
              >
                üåê Site
              </a>
            )}
          </div>

          <div class="business-footer">
             <span class="last-updated">
              {business.description && (
                <span class="text-sm text-gray-500 block mt-2 italic">"{business.description}"</span>
              )}
             </span>
          </div>
        </div>
      );
    })}
  </div>

  {businesses.length === 0 && (
    <div class="no-results">
      <p>Nenhum profissional encontrado com esses crit√©rios.</p>
    </div>
  )}
</div>

<style>
  /* Same styles as before, just added verified badge style */
  .business-directory {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .directory-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .directory-header h1 {
    font-size: 2.5rem;
    color: #1a202c;
    margin-bottom: 0.5rem;
  }

  .subtitle {
    font-size: 1.125rem;
    color: #718096;
  }

  .filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .search-box {
    flex: 1;
    min-width: 250px;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 1rem;
  }

  .filter-select {
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 1rem;
    background: white;
  }

  .filter-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #f7fafc;
    border-radius: 8px;
    cursor: pointer;
  }

  .results-count {
    margin-bottom: 1.5rem;
    color: #4a5568;
    font-weight: 500;
  }

  .business-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .business-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }

  .business-card:hover {
    border-color: #3182ce;
    box-shadow: 0 4px 12px rgba(49, 130, 206, 0.15);
    transform: translateY(-2px);
  }

  .business-header {
    margin-bottom: 1rem;
  }

  .business-name {
    font-size: 1.25rem;
    color: #1a202c;
    margin-bottom: 0.5rem;
  }

  .rating {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .stars {
    color: #f59e0b;
    font-weight: 600;
  }

  .reviews {
    color: #718096;
    font-size: 0.875rem;
  }

  .business-info {
    margin-bottom: 1.5rem;
  }

  .location {
    color: #4a5568;
    margin-bottom: 0.25rem;
    font-weight: 500;
  }

  .address {
    color: #718096;
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  .badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-24h {
    background: #10b981;
    color: white;
  }

  .badge-women {
    background: #ec4899;
    color: white;
  }

  .badge-lgbtq {
    background: linear-gradient(90deg, #e74c3c, #f39c12, #f1c40f, #2ecc71, #3498db, #9b59b6);
    color: white;
  }
  
  .badge-verified {
    background: #4299e1;
    color: white;
  }

  .business-actions {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .btn {
    flex: 1;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .btn-call {
    background: #3182ce;
    color: white;
  }

  .btn-call:hover {
    background: #2c5282;
  }

  .btn-whatsapp {
    background: #25d366;
    color: white;
  }

  .btn-whatsapp:hover {
    background: #1da851;
  }

  .btn-website {
    background: #718096;
    color: white;
  }

  .btn-website:hover {
    background: #4a5568;
  }

  .business-footer {
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
  }

  .last-updated {
    font-size: 0.75rem;
    color: #a0aec0;
  }

  .no-results {
    text-align: center;
    padding: 3rem;
    color: #718096;
  }

  @media (max-width: 768px) {
    .business-grid {
      grid-template-columns: 1fr;
    }

    .filters {
      flex-direction: column;
    }

    .business-actions {
      flex-direction: column;
    }
  }
</style>

<script>
  // Search and filter functionality
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  const neighborhoodFilter = document.getElementById('neighborhoodFilter') as HTMLSelectElement;
  const only24hCheckbox = document.getElementById('only24h') as HTMLInputElement;
  const businessCards = document.querySelectorAll('.business-card');
  const resultCount = document.getElementById('resultCount');

  function filterBusinesses() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedNeighborhood = neighborhoodFilter.value;
    const only24h = only24hCheckbox.checked;

    let visibleCount = 0;

    businessCards.forEach((card) => {
      const name = card.getAttribute('data-name') || '';
      const neighborhood = card.getAttribute('data-neighborhood') || '';
      const is24h = card.getAttribute('data-is24h') === 'true';

      const matchesSearch = name.includes(searchTerm) || neighborhood.toLowerCase().includes(searchTerm);
      const matchesNeighborhood = !selectedNeighborhood || neighborhood === selectedNeighborhood;
      const matches24h = !only24h || is24h;

      if (matchesSearch && matchesNeighborhood && matches24h) {
        (card as HTMLElement).style.display = 'block';
        visibleCount++;
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });

    if (resultCount) {
      resultCount.textContent = visibleCount.toString();
    }
  }

  searchInput?.addEventListener('input', filterBusinesses);
  neighborhoodFilter?.addEventListener('change', filterBusinesses);
  only24hCheckbox?.addEventListener('change', filterBusinesses);
</script>